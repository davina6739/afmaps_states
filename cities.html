<html>
  <head>
      <style>
        #container {
          width:100%; height:100%; margin: 0 auto 0 auto; text-align:center; vertical-align:middle;
        }
      </style>
      <link rel="stylesheet" type="text/css" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/pace.min.js"></script>
  </head>
  <body>
      <div id="container">
        Downloading map...
      </div>
  </body>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.3.6/proj4.js"></script>
  <script src="https://code.highcharts.com/maps/highmaps.src.js"></script>
  <script src="https://code.highcharts.com/maps/modules/data.js"></script>
  <script src="https://code.highcharts.com/maps/modules/exporting.js"></script>
  <script src="https://code.highcharts.com/mapdata/countries/us/us-all.js"></script>
  <script src="base.js"></script>
  <script>

  function drawMap () {

    var H = Highcharts;
    Highcharts.data({
      //googleSpreadsheetKey: '12YB8ZFCX8LjQMs1PW5v8gpTZw-B7Ud0p2M3pS9yrTds',

      googleSpreadsheetKey: '1qY_kAid_DAWliQVdOBEiSkrq5WcCxRHjxT32UcCpHn8',
      //googleSpreadsheetWorksheet: 'Sheet1',
      //firstRowAsNames: true,

      parsed: function(columns) {
        var data = [];
        $.each(columns[0], function(i, code) {
          if ((columns[3][i]!=0)&&(columns[4][i]!= 0)&&(parseFloat(columns[2][i])!=0))
          {
            var maxValue = 99;
            var bg = parseInt(parseFloat(columns[2][i]));
            data.push({
              // the county code needs to be prefixed with "us-"
              name: columns[1][i],
              value: parseFloat(columns[2][i]),
              lat: columns[3][i],
              lon: columns[4][i],
            })
            code.z = columns[2][i];

            if (0<bg && bg<25)    code.color = '#C4CEE6';
            if (25<=bg && bg<50)  code.color = '#94CBA9';
            if (50<=bg && bg<75)  code.color = '#4c73a1';
            if (75<=bg && bg<100) code.color = '#184a83';

          }
        });

        console.log(data);

        var citiesMap = Highcharts.geojson(Highcharts.maps['countries/us/us-all']),
        options;

        options = {
          title: {
              text: 'Highmaps lat/lon demo'
          },

          tooltip: {
              pointFormat: '{point.name}' +
                  'Lat: {point.lat}<br>' +
                  'Lon: {point.lon}<br>' +
                  'Rank: {point.value}'
          },

          xAxis: {
              crosshair: {
                  zIndex: 5,
                  dashStyle: 'dot',
                  snap: false,
                  color: 'gray'
              }
          },

          mapNavigation: {
            enabled: true
          },

          yAxis: {
              crosshair: {
                  zIndex: 5,
                  dashStyle: 'dot',
                  snap: false,
                  color: 'gray'
              }
          },

          series: [{
              animation: true,
              name: 'Basemap',
              mapData: Highcharts.maps['countries/us/us-all'],
              borderColor: '#606060',
              nullColor: 'rgba(200, 200, 200, 0.2)',
              showInLegend: false
          }, {
              name: 'Separators',
              type: 'mapline',
              color: '#101010',
              enableMouseTracking: false,
              showInLegend: false
          }, {
              type: 'mapbubble',
              dataLabels: {
                  enabled: false,
                  format: '{point.name}'
              },
              name: 'Cities',
              data: data,
              maxSize: '3%'
          }]
        };
        // Instanciate the map
        $('#container').highcharts('Map', options);

              // Display custom label with lat/lon next to crosshairs
              $('#container').mousemove(function (e) {
                  var position;

                  if (chart) {
                      if (!chart.lab) {
                          chart.lab = chart.renderer.text('', 0, 0)
                              .attr({
                                  zIndex: 5
                              })
                              .css({
                                  color: '#505050'
                              })
                              .add();
                      }

                      e = chart.pointer.normalize(e);
                      position = chart.fromPointToLatLon({
                          x: chart.xAxis[0].toValue(e.chartX),
                          y: chart.yAxis[0].toValue(e.chartY)
                      });

                      chart.lab.attr({
                          x: e.chartX + 5,
                          y: e.chartY - 22,
                          text: 'Lat: ' + position.lat.toFixed(2) + '<br>Lon: ' + position.lon.toFixed(2)
                      });
                  }
              });

              $('#container').mouseout(function () {
                  if (chart && chart.lab) {
                      chart.lab.destroy();
                      chart.lab = null;
                  }
              });


      }
    });
  }

  drawMap ();


  </script>
</head>
